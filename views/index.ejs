<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/"><%= title %></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/events">Event Manager</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/loans">Loan Manager</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users">Users</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-5">
      <div class="row">
        <div class="col-md-12">
          <h1 class="mb-4"><%= title %></h1>
          
          <!-- Financial Summary Cards -->
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="card bg-success text-white">
                <div class="card-body">
                  <h5 class="card-title">Total Income</h5>
                  <p class="card-text h4">¥<%= income %></p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-danger text-white">
                <div class="card-body">
                  <h5 class="card-title">Total Expenses</h5>
                  <p class="card-text h4">¥<%= expenses %></p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card <% if(balance >= 0) { %>bg-primary<% } else { %>bg-warning<% } %> text-white">
                <div class="card-body">
                  <h5 class="card-title">Balance</h5>
                  <p class="card-text h4">¥<%= balance %></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Loan Summary Cards -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title text-muted">Total Loan Principal</h6>
                      <p class="card-text h5 text-danger fw-bold">¥<%= totalLoans %></p>
                    </div>
                    <a href="/loans" class="btn btn-sm btn-outline-primary">Manage</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title text-muted">Active Loans</h6>
                      <p class="card-text h5"><%= activeLoans %></p>
                    </div>
                    <a href="/loans" class="btn btn-sm btn-outline-primary">View All</a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts and Calendar Row -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-dark text-white">
                  <h5 class="mb-0">Income vs Expenses Overview</h5>
                </div>
                <div class="card-body">
                  <canvas id="overviewChart"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-dark text-white">
                  <h5 class="mb-0">Expense Breakdown by Category</h5>
                </div>
                <div class="card-body">
                  <canvas id="categoryChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Calendar -->
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header bg-dark text-white">
                  <h5 class="mb-0">Financial Calendar - Events with Amounts</h5>
                </div>
                <div class="card-body">
                  <div id="calendar"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script>
      // Data from server
      const events = <%- JSON.stringify(events) %>;
      const expensesByCategory = <%- expensesByCategory %>;
      const incomeByCategory = <%- incomeByCategory %>;
      const income = parseFloat('<%- income %>');
      const expenses = parseFloat('<%- expenses %>');

      document.addEventListener('DOMContentLoaded', function() {
        // Initialize Calendar with financial events
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          height: 'auto',
          events: events,
          eventDisplay: 'block'
        });
        calendar.render();
      });

      // Income vs Expenses Overview Chart
      const overviewCtx = document.getElementById('overviewChart').getContext('2d');
      const overviewChart = new Chart(overviewCtx, {
        type: 'doughnut',
        data: {
          labels: ['Income (¥)', 'Expenses (¥)'],
          datasets: [{
            data: [income, expenses],
            backgroundColor: [
              'rgba(25, 135, 84, 0.8)',
              'rgba(220, 53, 69, 0.8)'
            ],
            borderColor: [
              'rgba(25, 135, 84, 1)',
              'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': ¥' + context.parsed.toFixed(2);
                }
              }
            }
          }
        }
      });

      // Expense Breakdown by Category Chart
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      const categoryLabels = Object.keys(expensesByCategory);
      const categoryData = Object.values(expensesByCategory);
      
      const colors = [
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(199, 199, 199, 0.8)',
        'rgba(83, 102, 255, 0.8)'
      ];

      const categoryChart = new Chart(categoryCtx, {
        type: 'bar',
        data: {
          labels: categoryLabels.length > 0 ? categoryLabels : ['No Expenses'],
          datasets: [{
            label: 'Expenses by Category (¥)',
            data: categoryData.length > 0 ? categoryData : [0],
            backgroundColor: categoryData.length > 0 
              ? colors.slice(0, categoryData.length)
              : ['rgba(200, 200, 200, 0.8)'],
            borderColor: categoryData.length > 0 
              ? colors.slice(0, categoryData.length).map(c => c.replace('0.8', '1'))
              : ['rgba(100, 100, 100, 1)'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return '¥' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '¥' + value.toFixed(0);
                }
              }
            }
          }
        }
      });
    </script>
  </body>
</html>
